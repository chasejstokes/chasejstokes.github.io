<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo</title>
</head>

<body>

    <!-- using style rather than .css stylesheet to keep everything in one file -->
    <style>
        img {
            width: 60%;
        }

        textarea {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 0.9em;
        }

        .center-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            min-height: 85vh;
        }

        .instructions {
            margin-top: 2.5%;
            margin-left: 10%;
            margin-right: 10%;
        }

        span {
            cursor: pointer;
        }
    </style>

    <div class=instructions>
        <h1>Instructions</h1>
        <p>Click anywhere to add an annotation, title, or caption. Type the text you would like to add, then press enter
            to add it. Drag and drop the text to adjust the position. Double click anywhere on the text or input box to
            remove it. When you are finished, click the
            button below to save your design.</p>
        <button id='saveImg'>Save Image</button>
    </div>

    <div id="parent_div">
        <div id="demo_div" class="center-screen">
            <img src=" line000.png">
        </div>
    </div>

    <script>

        document.getElementById("parent_div").onclick = function (e) {

            // check to see if the target an image or a div to add text to
            if (e.target.tagName === "IMG" || e.target.tagName === "DIV") {

                // create textarea variable
                var textNode = document.createElement('textarea')

                // save the location of the click
                x = e.clientX
                y = e.clientY

                // update the location of the text
                textNode.style.left = x + "px"
                textNode.style.top = y + "px"
                textNode.style.zIndex = 1
                textNode.style.position = "absolute"

                // set properties to the text according to position relative to image
                chart = document.querySelector('img')
                if (y > chart.y) {
                    textNode.style.width = chart.width * 0.75 + "px"
                    textNode.rows = 2
                    textNode.style.fontSize = "1.2em"
                    if (y < (chart.y + chart.height)) {
                        textNode.style.width = "200px"
                    }
                } else {
                    textNode.style.width = chart.width * 0.75 + "px"
                    textNode.rows = 1
                    textNode.style.fontSize = "1.75em"
                }


                // append textarea to document
                document.getElementById("parent_div").appendChild(textNode)

                // focus on the input to type text in
                textNode.focus()

                // if the input is double clicked, remove it
                textNode.addEventListener("dblclick", function () {
                    textNode.remove()
                })

                // when the input is submitted
                textNode.addEventListener("keypress", function (e) {

                    // if "enter" was pressed
                    if (e.keyCode == 13) {

                        // create span
                        var spanNode = document.createElement('span')

                        // add text to span
                        spanNode.innerHTML = textNode.value;

                        // adjust span attributes
                        spanNode.style.position = "absolute"
                        spanNode.style.left = textNode.style.left
                        spanNode.style.top = textNode.style.top
                        spanNode.style.zIndex = 1

                        // set properties to the span according to position relative to image
                        if (y > chart.y) {
                            spanNode.style.maxWidth = chart.width + "px"
                            spanNode.style.fontSize = "1.25em"
                            if (y < (chart.y + chart.height)) {
                                spanNode.style.maxWidth = "200px"
                            }
                        } else {
                            spanNode.style.maxWidth = chart.width + "px"
                            spanNode.style.fontSize = "1.75em"
                        }

                        // add event listener to remove span when double clicked
                        spanNode.addEventListener("dblclick", function (e) {
                            spanNode.remove()
                        })

                        // initialize the isDragging flag to false
                        var isDragging = false;

                        // add a mousedown event listener to the span element
                        spanNode.addEventListener('mousedown', function (e) {
                            // set the isDragging flag to true
                            isDragging = true;

                            // update the x and y coordinates of the span
                            spanX = e.clientX;
                            spanY = e.clientY;
                        });

                        // add a mousemove event listener to the document
                        document.addEventListener('mousemove', function (e) {
                            // if the isDragging flag is true
                            if (isDragging) {
                                // calculate the distance the mouse has moved since the last mousemove event
                                var dx = e.clientX - spanX;
                                var dy = e.clientY - spanY;

                                // update the x and y coordinates of the span
                                spanX = e.clientX;
                                spanY = e.clientY;

                                // update the position of the span by adding the distance the mouse has moved to its current position
                                spanNode.style.left = spanNode.offsetLeft + dx + 'px';
                                spanNode.style.top = spanNode.offsetTop + dy + 'px';
                            }
                        });

                        // add a mouseup event listener to the document
                        document.addEventListener('mouseup', function (e) {
                            // set the isDragging flag to false
                            isDragging = false;
                        })

                        // add span
                        document.getElementById("parent_div").appendChild(spanNode)

                        // if span is empty, remove
                        if (spanNode.innerText === "") {
                            spanNode.remove()
                        }

                        // remove the textarea node
                        textNode.remove()

                    }

                })
            }
        }
        document.getElementById("saveImg").onclick = function (e) {

            // Create element with <a> tag
            const link = document.createElement("a");

            // Create a blog object with the file content which you want to add to the file
            const file = new Blob([document.body.innerHTML], { type: 'text/plain' });

            // Add file content in the object URL
            link.href = URL.createObjectURL(file);

            // Add file name
            link.download = "design.txt";

            // Add click event to <a> tag to save file.
            link.click();
            URL.revokeObjectURL(link.href);

        }


    </script>
</body>

</html>


</body>

</html>