<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Design</title>
</head>

<body>

    <!-- using style rather than .css stylesheet to keep everything in one file -->
    <style>
        body {
            margin: 25px;
        }

        span {
            cursor: pointer;
        }

        p {
            margin-right: 40px;
        }

        .instructions {
            display: inline-block;
            vertical-align: top;
            margin-bottom: 25px;
            width: 350px;
        }

        #wrapper {
            display: inline;
        }

        #design {
            border: 2px solid black;
            position: absolute;
        }

        #aboveCanvas {
            position: absolute;
            z-index: 1;
        }

        /* switch css  */

        fieldset {
            border: 0;
        }

        .itemLabel {
            display: inline-block;

        }

        .itemContainer {
            display: flex;
            align-items: center;
            height: 30px;
        }

        /* The toggle look */
        .itemToggler {
            position: relative;
            display: inline-block;
            width: 20px;
            height: 20px;
            margin: 5px;
            background-color: lightgray;
            border: 1px solid black;
            cursor: pointer;
        }

        #textToggler {
            background-image: url('http://chasejstokes.github.io/research_materials/text.png');
            background-size: 15px;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* Hide default HTML checkbox */
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        input:checked+.itemToggler {
            background-color: gray;
            border: 2px solid black;
        }
    </style>



    <div id="parent_div">
        <div class=instructions>
            <h1>Instructions</h1>
            <p>
                <b>Before beginning, make sure your browser window is sufficiently wide. You should see the box
                    enclosing the chart in its entirety.</b>
            </p>
            <p>
                <b>Adding Text:</b> Double click anywhere to add an input box. Type your desired text in the box,
                and hit "Enter" to add the text. The text size is pre-determined by where on the chart you click and not
                possible to change.
            <p>
                <b>Moving Text:</b> Once the text or input box is added to the chart, click and drag it to the position
                you want.
            <p>
                <b>Deleting Text:</b> Double-click anywhere on added text to remove it. If you accidentally add an
                input box where you did not mean to, double click anywhere in the box to remove it.
            </p>
            <p>
                <b>Saving Your Design:</b> When you are finished with your design, click the button below to
                automatically download a .html file containing the image to your computer. Upload this file
                in the next question After uploading, you can remove the downloaded file from your device.
            </p>

            <fieldset>
                <div class="itemContainer">

                    <label class="switch">
                        <input type="radio" id="addText" name="item" value="text" />
                        <span class="itemToggler" id="textToggler"></span>
                    </label>

                    <label class="switch">
                        <input type="radio" id="addPoint" name="item" value="point" />
                        <span class="itemToggler" id="pointToggler"></span>
                    </label>

                    <label class="switch">
                        <input type="radio" id="addLine" name="item" value="line" />
                        <span class="itemToggler" id="lineToggler"></span>
                    </label>

                </div>

            </fieldset>

            <br>
            <button id='saveImg'>Download File</button>
        </div>
        <div id="wrapper">
            <canvas id="design" width="800" height="500">
            </canvas>
            <div id="layer"></div>

        </div>
    </div>

    <script>

        // build the chart on the canvas
        var canvas = document.getElementById("design");
        var context = canvas.getContext("2d");
        line001 = new Image();
        line001.src = 'http://chasejstokes.github.io/research_materials/chart.png';
        line001.style.border = "2px black solid"
        line001.onload = function () {
            context.drawImage(line001, 0, 0);
        }

        // get canvas location
        var x = canvas.offsetLeft
        var y = canvas.offsetTop

        // update the position and size of the aboveCanvas div
        layer = document.getElementById('layer')
        layer.style.left = x
        layer.style.top = y
        layer.width = canvas.width
        layer.height = canvas.height

        // set text attributes
        var largeText = '20px'
        var regularText = '14px'
        var longWidth = '50ch'
        var regularWidth = '15ch'

        // ADD INPUT ON DOUBLE CLICK
        document.getElementById("wrapper").ondblclick = function (e) {

            // create textarea variable
            var textNode = document.createElement('textarea')

            // save the location of the click
            clickX = e.clientX
            clickY = e.clientY

            // update the location of the text
            textNode.style.left = clickX + "px"
            textNode.style.top = clickY + "px"
            textNode.style.zIndex = 1
            textNode.style.position = "absolute"
            textNode.style.fontFamily = "Arial, Helvetica, sans-serif"
            textNode.style.background = "none"
            textNode.style.border = "1px solid black"
            textNode.style.lineHeight = 1

            chart = document.querySelector('canvas')
            // assign condition
            if (clickY > (0.9 * (canvas.height + y))) {
                textNode.classList.add('caption')
            } else if (clickY < (0.2 * (canvas.height + y))) {
                textNode.classList.add('title')
            } else {
                textNode.classList.add('annotation')
            }
            // set properties to the text according to position relative to canvas
            if (textNode.className === 'annotation') {
                textNode.style.width = regularWidth
                textNode.style.fontSize = regularText
            }
            if (textNode.className === 'caption') {
                textNode.style.width = longWidth
                textNode.style.fontSize = regularText
            }
            if (textNode.className === 'title') {
                textNode.style.width = longWidth
                textNode.style.fontSize = largeText
            }


            // append textarea to document
            document.getElementById("parent_div").appendChild(textNode)

            // focus on the input to type text in
            textNode.focus()

            // add a drag and drop to the input
            // initialize the isDraggingInput flag to false
            var isDraggingInput = false;
            // add a mousedown event listener to the span element
            textNode.addEventListener('mousedown', function (e) {
                // set the isDraggingInput flag to true
                isDraggingInput = true;
                // update the x and y coordinates of the input
                inputX = e.clientX;
                inputY = e.clientY;
                y_position = e.clientY - parseInt(textNode.style.top)
            });
            // add a mousemove event listener to the document
            document.addEventListener('mousemove', function (e) {
                // if the isDraggingInput flag is true
                if (isDraggingInput) {
                    // calculate the distance the mouse has moved since the last mousemove event
                    var dx = e.clientX - inputX;
                    var dy = e.clientY - inputY;
                    // update the x and y coordinates of the input
                    inputX = e.clientX;
                    inputY = e.clientY;
                    // update the position of the input by adding the distance the mouse has moved to its current position
                    textNode.style.left = textNode.offsetLeft + dx + 'px';
                    textNode.style.top = e.clientY - y_position + dy + 'px';
                }
            });
            // add a mouseup event listener to the document
            document.addEventListener('mouseup', function (e) {
                // set the isDraggingInput flag to false
                isDraggingInput = false;
            })

            // if the input is double clicked, remove it
            textNode.addEventListener("dblclick", function () {
                textNode.remove()
            })

            // when the input is submitted
            textNode.addEventListener("keypress", function (e) {

                // if "enter" was pressed
                if (e.keyCode == 13) {

                    // create span
                    var spanNode = document.createElement('span')

                    // add text to span
                    spanNode.innerHTML = textNode.value;

                    // adjust span attributes
                    spanNode.style.position = "absolute"
                    spanNode.style.left = parseInt(textNode.style.left) + 2.5 + "px"
                    spanNode.style.top = parseInt(textNode.style.top) + 4.5 + "px"
                    spanNode.style.zIndex = 1

                    // set properties to the text according to position relative to canvas
                    if (textNode.className === 'annotation') {
                        spanNode.style.width = regularWidth
                        spanNode.style.fontSize = regularText
                        spanNode.classList.add('annotation')
                    }
                    if (textNode.className === 'caption') {
                        spanNode.style.width = longWidth
                        spanNode.style.fontSize = regularText
                        spanNode.classList.add('caption')
                    }
                    if (textNode.className === 'title') {
                        spanNode.style.width = longWidth
                        spanNode.style.fontSize = largeText
                        spanNode.classList.add('title')
                    }

                    // add event listener to remove span when double clicked
                    spanNode.addEventListener("dblclick", function (e) {
                        spanNode.remove()
                    })

                    // initialize the isDraggingSpan flag to false
                    var isDraggingSpan = false;
                    // add a mousedown event listener to the span element
                    spanNode.addEventListener('mousedown', function (e) {
                        // set the isDraggingSpan flag to true
                        isDraggingSpan = true;
                        // update the x and y coordinates of the span
                        spanX = e.clientX;
                        spanY = e.clientY;
                    });
                    // add a mousemove event listener to the document
                    document.addEventListener('mousemove', function (e) {
                        // if the isDraggingSpan flag is true
                        if (isDraggingSpan) {
                            // calculate the distance the mouse has moved since the last mousemove event
                            var dx = e.clientX - spanX;
                            var dy = e.clientY - spanY;
                            // update the x and y coordinates of the span
                            spanX = e.clientX;
                            spanY = e.clientY;
                            // update the position of the span by adding the distance the mouse has moved to its current position
                            spanNode.style.left = spanNode.offsetLeft + dx + 'px';
                            spanNode.style.top = spanNode.offsetTop + dy + 'px';
                        }
                    });
                    // add a mouseup event listener to the document
                    document.addEventListener('mouseup', function (e) {
                        // set the isDraggingSpan flag to false
                        isDraggingSpan = false;
                    })

                    // add span
                    document.getElementById("parent_div").appendChild(spanNode)

                    // if span is empty, remove
                    if (spanNode.innerText === "") {
                        spanNode.remove()
                    }

                    // remove the textarea node
                    textNode.remove()

                }

            })
        }

        // helper function to add text to the canvas
        function getLines(span, maxWidth) {
            const words = span.split(" ");
            const lines = [];
            while (words.length > 0) {
                let line = "";
                while (words.length > 0 && (line + words[0]).length <= maxWidth) {
                    line += words.shift() + " ";
                }
                lines.push(line.trim());
            }
            return lines;
        }

        // ADD POINT
        //
        //
        num_points = 0
        document.addEventListener('click', function (e) {

            console.log(e.target)

            if (e.target.tagName.toUpperCase() == "CANVAS") {

                if (document.getElementById('addPoint').checked) {
                    num_points += 1;

                    var container_size = 14
                    var radius_size = (container_size / 2) - 1
                    var pointX = e.clientX
                    var pointY = e.clientY
                    num_points += 1;

                    // create the circle
                    var point = document.createElementNS("http://www.w3.org/2000/svg", 'svg');
                    point.setAttributeNS(null, 'width', container_size);
                    point.setAttributeNS(null, 'height', container_size);
                    point.id = "svg_container" + num_points;
                    point.style.top = pointY - radius_size + "px";
                    point.style.left = pointX - radius_size + "px";
                    point.style.zIndex = 2;
                    point.style.position = "absolute";
                    var circ = document.createElementNS("http://www.w3.org/2000/svg", 'circle');
                    circ.setAttributeNS(null, 'cx', radius_size);
                    circ.setAttributeNS(null, 'cy', radius_size);
                    circ.setAttributeNS(null, 'r', radius_size);
                    document.getElementById("wrapper").appendChild(point);
                    document.getElementById("svg_container" + num_points).appendChild(circ);


                    // adding event listeners for drag and dropping
                    // initialize the isDraggingPoint flag to false
                    var isDraggingPoint = false;
                    // add a mousedown event listener to the point element
                    point.addEventListener('mousedown', function (e) {
                        // set the isDraggingPoint flag to true
                        isDraggingPoint = true;
                        // update the x and y coordinates of the point
                        pointX = e.clientX;
                        pointY = e.clientY;
                        x_point_position = e.clientX - parseInt(point.style.left)
                        y_point_position = e.clientY - parseInt(point.style.top)
                    });
                    // add a mousemove event listener to the document
                    document.addEventListener('mousemove', function (e) {
                        // if the isDraggingPoint flag is true
                        if (isDraggingPoint) {
                            // calculate the distance the mouse has moved since the last mousemove event
                            var dx = e.clientX - pointX;
                            var dy = e.clientY - pointY;
                            // update the x and y coordinates of the point
                            pointX = e.clientX;
                            pointY = e.clientY;
                            // update the position of the point by adding the distance the mouse has moved to its current position
                            point.style.left = e.clientX - x_point_position + dx + 'px';
                            point.style.top = e.clientY - y_point_position + dy + 'px';
                        }
                    });
                    // add a mouseup event listener to the document
                    document.addEventListener('mouseup', function (e) {
                        // set the isDraggingPoint flag to false
                        isDraggingPoint = false;
                    })


                }
            }


        })
        document.getElementById("addPoint").onclick = function (e) {


        }

        // SAVEIMG BUTTON CLICK//
        //
        //
        //
        document.getElementById("saveImg").onclick = function (e) {

            // add all the unadded inputs
            //
            //
            var text_additions = document.querySelectorAll('textarea')
            for (let i = 0; i < text_additions.length; i++) {

                var textNode = text_additions[i]

                // create span
                var spanNode = document.createElement('span')

                // add text to span
                spanNode.innerHTML = textNode.value;

                // adjust span attributes
                spanNode.style.position = "absolute"
                spanNode.style.left = textNode.style.left
                spanNode.style.top = textNode.style.top
                spanNode.style.zIndex = 1

                // set properties to the text according to position relative to canvas
                if (textNode.className === 'annotation') {
                    spanNode.style.width = regularWidth
                    spanNode.style.fontSize = regularText
                    spanNode.classList.add('annotation')
                }
                if (textNode.className === 'caption') {
                    spanNode.style.width = longWidth
                    spanNode.style.fontSize = regularText
                    spanNode.classList.add('caption')
                }
                if (textNode.className === 'title') {
                    spanNode.style.width = longWidth
                    spanNode.style.fontSize = largeText
                    spanNode.classList.add('title')
                }

                // add event listener to remove span when double clicked
                spanNode.addEventListener("dblclick", function (e) {
                    spanNode.remove()
                })

                // initialize the isDragging flag to false
                var isDragging = false;
                // add a mousedown event listener to the span element
                spanNode.addEventListener('mousedown', function (e) {
                    // set the isDragging flag to true
                    isDragging = true;
                    // update the x and y coordinates of the span
                    spanX = e.clientX;
                    spanY = e.clientY;
                });
                // add a mousemove event listener to the document
                document.addEventListener('mousemove', function (e) {
                    // if the isDragging flag is true
                    if (isDragging) {
                        // calculate the distance the mouse has moved since the last mousemove event
                        var dx = e.clientX - spanX;
                        var dy = e.clientY - spanY;
                        // update the x and y coordinates of the span
                        spanX = e.clientX;
                        spanY = e.clientY;
                        // update the position of the span by adding the distance the mouse has moved to its current position
                        spanNode.style.left = spanNode.offsetLeft + dx + 'px';
                        spanNode.style.top = spanNode.offsetTop + dy + 'px';
                    }
                });
                // add a mouseup event listener to the document
                document.addEventListener('mouseup', function (e) {
                    // set the isDragging flag to false
                    isDragging = false;
                })

                // add span
                document.getElementById("parent_div").appendChild(spanNode)

                // if span is empty, remove
                if (spanNode.innerText === "") {
                    spanNode.remove()
                }

                // remove the textarea node
                textNode.remove()

            }

            // Create element with <a> tag
            const link = document.createElement("a");
            // Create a blog object with the file content which you want to add to the file
            const file = new Blob([document.documentElement.innerHTML], { type: 'text/html' });
            // Add file content in the object URL
            link.href = URL.createObjectURL(file);
            // Add file name
            link.download = "design001.html";
            // Add click event to <a> tag to save file.
            link.click();
            URL.revokeObjectURL(link.href);

        }


    </script>
</body>

</html>